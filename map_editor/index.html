<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Map editor</title>
</head>
<body>
    Select tool:
    <select id="wallTypeSelect">
        <option value="s" selected>Player start position</option>
        <option value="d">Door</option>
        <option value="1">Wall #1</option>
        <option value="2">Wall #2</option>
        <option value="3">Wall #3</option>
        <option value="4">Wall #4</option>
        <option value="5">Wall #5</option>
        <option value="6">Wall #6</option>
        <option value="7">Wall #7</option>
        <option value="8">Wall #8</option>
        <option value="9">Wall #9</option>
        <option value="0">Wall #0</option>
        <option value="c">Clear</option>
    </select>
    <input type="button" value="Clear all" id="clearAllBtn"></input>

    <br/>

    <canvas id="canvas" width="1" height="1" style="cursor: crosshair;"></canvas>

    <textarea id="textOutput" rows="40" cols="100"></textarea>

    <br/>

    <input type="button" value="Load from above text" id="loadBtn"></input>

    <script type="text/javascript">
        window.colorTable = {
            "s": "gold",
            "d": "#00FFFF",
            "1": "#000080",
            "2": "#800080",
            "3": "#008080",
            "4": "#808000",
            "5": "#FF00FF",
            "6": "#CCCCCC",
            "7": "#00FF00",
            "8": "#FF0000",
            "9": "#0000FF",
            "0": "#000000"
        };
        const canvas = document.getElementById('canvas');
        window.totalWidth = 78;
        window.totalHeight = 50;
        window.blockSize = 20;
        window.blocksPainted = 0;
        window.playerStartSetX = -1;
        window.playerStartSetY = -1;
        window.painting = false;
        canvas.width = window.totalWidth * window.blockSize;
        canvas.height = window.totalHeight * window.blockSize;

        var elemLeft = canvas.offsetLeft + canvas.clientLeft,
            elemTop = canvas.offsetTop + canvas.clientTop;

        canvas.addEventListener("mousemove", function (e) {
            if (window.painting) {
                window.paintPixel(e);
            }
        }, false);
        canvas.addEventListener("mousedown", function (e) {
            window.painting = true;
            window.paintPixel(e);
        }, false);
        canvas.addEventListener("mouseup", function (e) {
            window.painting = false;
            window.refreshTextOutput();
        }, false);
        canvas.addEventListener("mouseout", function (e) {
        }, false);

        window.paintPixel = function(evt) {
            var x = Math.round((evt.pageX - elemLeft) / window.blockSize - 0.5),
                y = Math.round((evt.pageY - elemTop) / window.blockSize - 0.5);

            var option = document.querySelector("select").selectedOptions[0];
            var value = option.getAttribute("value");
            var rgb = window.colorTable[value];

            if (x >= 0 && x < window.totalWidth && y >= 0 && y < window.totalHeight) {
                if (value == 'c') {
                    if (window.walls[y][x]) {
                        if (window.playerStartSetX === x && window.playerStartSetY === y) {
                            window.playerStartSetX = -1;
                        }
                        window.walls[y][x] = undefined;
                        window.blocksPainted--;
                    }
                } else if (value === 's') {
                    if (window.playerStartSetX !== -1) {
                        window.walls[window.playerStartSetY][window.playerStartSetX] = undefined;
                        window.playerStartSetX = -1;
                        window.blocksPainted--;
                    }

                    window.playerStartSetX = x;
                    window.playerStartSetY = y;
                    window.walls[y][x] = value;
                    window.blocksPainted++;
                } else if (window.walls[y][x] === value) {
                } else if (window.walls[y][x] === `s`) {
                    window.playerStartSetX = -1;
                    window.walls[y][x] = value;
                } else {
                    window.walls[y][x] = value;
                    window.blocksPainted++;
                }

                window.refreshCanvas();
            }
        };

        window.ctx = canvas.getContext('2d');
        window.walls = Array.from(Array(window.totalWidth), () => new Array(window.totalHeight));

        window.refreshCanvas = function() {
            window.ctx.fillStyle = 'gray';
            window.ctx.fillRect(0, 0, window.totalWidth * window.blockSize, window.totalHeight * window.blockSize);

            for (var y = 0; y < window.totalHeight; ++y) {
                for (var x = 0; x < window.totalWidth; ++x) {
                    if (window.walls[y][x]) {
                        window.ctx.fillStyle = window.colorTable[window.walls[y][x]];
                        window.ctx.fillRect(x * window.blockSize, y * window.blockSize, window.blockSize,window.blockSize);
                    }
                }
            }
        };

        window.refreshTextOutput = function() {
            var text = document.getElementById("textOutput");
            if (window.blocksPainted === 0) {
                text.value = "Invalid level design - must be at least 3x3";
                return;
            }
            if (window.playerStartSetX === -1) {
                text.value = "Player start position must be set";
                return;
            }

            var minX = -1,
                maxX = -1,
                minY = -1,
                maxY = -1;

            var safety_code = -1;

            for (var y = 0; y < window.totalHeight; ++y) {
                for (var x = 0; x < window.totalWidth; ++x) {
                    if (!window.walls[y][x]) { continue; }

                    if (minX === -1 || x < minX) { minX = x; }
                    if (maxX === -1 || x > maxX) { maxX = x; }
                    if (minY === -1 || y < minY) { minY = y; }
                    if (maxY === -1 || y > maxY) { maxY = y; }

                    if (safety_code === -1) {
                        var code = window.walls[y][x];
                        safety_code = code;
                    }
                }
            }

            if (maxY - minY < 2 || maxX - minX < 2) {
                text.value = "Invalid level design - must be at least 3x3";
                return;
            }

            var output = "";

            for (var y = minY; y < maxY + 1; ++y) {
                for (var x = minX; x < maxX + 1; ++x) {
                    var atBorder = y === minY || y === maxY || x === minX || x === maxX;

                    if (window.walls[y][x]) {
                        var code = window.walls[y][x];

                        if (code === 's' && atBorder) {
                            text.value = "Invalid level design - player start position cannot be at the edge";
                            return;
                        }
                        output += code;
                    } else {
                        output += atBorder ? safety_code : ".";

                    }
                }
                output += "\n";
            }

            text.value = output;
        };

        document.getElementById("loadBtn").addEventListener("click", function() {
            var text = document.getElementById("textOutput");
            var textContent = (text.value + "").trim();
            var newWalls = Array.from(Array(window.totalWidth), () => new Array(window.totalHeight));
            var newBlocksPainted = 0;
            var newPlayerStartSetX = -1;
            var newPlayerStartSetY = -1;

            var x = 0;
            var y = 0;
            for (var i = 0; i < textContent.length; ++i) {
                var c = textContent.charAt(i);
                if (c === '\n') {
                    if (x === 0 && y === 0) {
                        continue;
                    }
                    x = 0;
                    y++;
                    continue;
                } else if (c === ' ' || c === '.') {
                    // do nothing
                } else if (c === 's') {
                    if (newPlayerStartSetX !== -1) {
                        text.value = `Error: multiple starting player positions (${x},${y})`;
                        return;
                    }
                    newPlayerStartSetX = x;
                    newPlayerStartSetY = y;
                    newWalls[y][x] = c;
                    newBlocksPainted++;
                } else if (c === 'd' || (c >= '0' && c <= '9')) {
                    newWalls[y][x] = c;
                    newBlocksPainted++;
                } else {
                    text.value = `Error: invalid character "${c}" (${x},${y})`;
                    return;
                }

                x++;
            }

            window.blocksPainted = newBlocksPainted;
            window.playerStartSetX = newPlayerStartSetX;
            window.playerStartSetY = newPlayerStartSetY;
            window.walls = newWalls;
            window.refreshCanvas();
            window.refreshTextOutput();
        });

        document.getElementById("clearAllBtn").addEventListener("click", function() {
            window.blocksPainted = 0;
            window.playerStartSetX = -1;
            window.playerStartSetY = -1;
            window.walls = Array.from(Array(window.totalWidth), () => new Array(window.totalHeight));;
            window.refreshCanvas();
            window.refreshTextOutput();
        });

        window.refreshCanvas();
        window.refreshTextOutput();
    </script>
</body>
</html>
